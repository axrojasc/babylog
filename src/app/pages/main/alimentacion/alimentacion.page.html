<app-header [showMenu]="true" title="Alimentación"></app-header>

<ion-content class="alimentacion-page ion-padding">

  <!-- DASHBOARD -->
  <div class="dashboard">

    <div class="dash-card">
      <h3>Calorías hoy</h3>
      <p>{{ totalCaloriasDia }} kcal</p>
    </div>

    <div class="dash-card">
      <h3>Gramos consumidos</h3>
      <p>{{ totalGramosDia }} g</p>
    </div>

    <div class="dash-card">
      <h3>Comidas hoy</h3>
      <p>{{ totalComidasDia }}</p>
    </div>

    <div class="dash-card">
      <h3>Última comida</h3>
      <p>{{ ultimaComida }}</p>
    </div>

  </div>

  <!-- GRÁFICO SEMANAL -->
  <h2 class="section-title">Analítica semanal</h2>
  <div class="grafico-container">
    <canvas id="graficoSemanal"></canvas>
  </div>

  <!-- BUSCADOR -->
  <ion-searchbar placeholder="Buscar alimento..." [(ngModel)]="busqueda"></ion-searchbar>

  <ion-button expand="block" class="ion-margin-top" (click)="abrirFormulario()">
    Añadir registro
  </ion-button>

  <!-- HISTORIAL -->
  <h2 class="section-title">Historial de comidas</h2>

  <div *ngIf="(registros?.length || 0) === 0" class="empty-text">
    No hay comidas registradas aún.
  </div>

  <!-- GRID DE 2 COLUMNAS -->
  <div class="grid-meals">

    <div class="card-meal" *ngFor="let r of filtrar(registros)">

      <div class="card-left">
        <div class="meal-time">{{ getDiaSemana(r.fecha) }} - {{ getHora(r.fecha) }}</div>
        <div class="meal-name">{{ r.alimento }}</div>

        <div class="meal-meta">
          {{ r.categoria }} • {{ r.cantidad }} g
          <span *ngIf="r.calorias !== null">• {{ r.calorias }} kcal</span>
        </div>
      </div>

      <div class="card-actions">
        <ion-button fill="clear" color="warning" (click)="abrirFormulario(r)">
          <ion-icon name="create-outline"></ion-icon>
        </ion-button>

        <ion-button fill="clear" color="danger" (click)="eliminarRegistro(r.id)">
          <ion-icon name="trash-outline"></ion-icon>
        </ion-button>
      </div>

    </div>

  </div>

  <!-- MODAL -->
  <ion-modal [isOpen]="mostrarFormulario" (didDismiss)="cerrarFormulario()">
    <ng-template>

      <ion-header>
        <ion-toolbar>
          <ion-title>{{ registroEditandoId ? 'Editar registro' : 'Nuevo registro' }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarFormulario()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">

        <form [formGroup]="form" (ngSubmit)="guardarRegistro()">

          <!-- ALIMENTO -->
          <ion-item>
            <ion-label position="floating">Alimento</ion-label>
            <ion-input formControlName="alimento" (ionInput)="buscarAlimento($event)"></ion-input>
          </ion-item>

          <!-- RESULTADOS API -->
          <ion-list *ngIf="resultadosAPI.length > 0" class="resultados-api">
            <ion-item button *ngFor="let item of resultadosAPI" (click)="seleccionarAlimento(item)">
              {{ item.name }} • {{ item.calories }} kcal • {{ item.serving_size_g ?? 100 }} g
            </ion-item>
          </ion-list>

          <!-- CANTIDAD -->
          <ion-item>
            <ion-label position="floating">Cantidad (gramos)</ion-label>
            <ion-input formControlName="cantidad" type="number"></ion-input>
          </ion-item>

          <!-- CATEGORÍA -->
          <ion-item>
            <ion-label position="floating">Categoría</ion-label>
            <ion-select formControlName="categoria">
              <ion-select-option value="Desayuno">Desayuno</ion-select-option>
              <ion-select-option value="Almuerzo">Almuerzo</ion-select-option>
              <ion-select-option value="Cena">Cena</ion-select-option>
              <ion-select-option value="Snack">Snack</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- CALORÍAS -->
          <ion-item>
            <ion-label position="floating">Calorías (kcal)</ion-label>
            <ion-input formControlName="calorias" type="number"></ion-input>
          </ion-item>

          <!-- FECHA -->
          <ion-item>
            <ion-label position="floating">Fecha</ion-label>
            <ion-datetime formControlName="fecha" presentation="date-time"></ion-datetime>
          </ion-item>

          <ion-button expand="full" type="submit" [disabled]="form.invalid" class="ion-margin-top">
            {{ registroEditandoId ? 'Actualizar' : 'Guardar' }}
          </ion-button>

        </form>

      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
